Build_Player_With_Tests_iOS:
  name: Build Players with tests iOS
  variables:
    UNITY_BRANCH: trunk
    GRAPHICS_BRANCH: master
  agent:
      # Do not choose machines with gpus or connected devices to perform this step
      # If it takes a lot of time to compile your project prefer flavor with more cores.
      # see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
      type: Unity::VM::osx
      image: mobile/macos-10.15-testing:stable
      flavor: b1.large
  commands:
    - git clone git@github.com:Unity-Technologies/Graphics.git && cd Graphics && git checkout $GRAPHICS_BRANCH
    - ls 
    - brew tap --force-auto-update unity/unity git@github.cds.internal.unity3d.com:unity/homebrew-unity.git
    - brew install unity-config
    - unity-config project add dependency "com.unity.render-pipelines.core@file:../Graphics/com.unity.render-pipelines.core" --project-path .
    - unity-config project add dependency "com.unity.render-pipelines.universal@file:../Graphics/com.unity.render-pipelines.universal" --project-path .
    - unity-config project add dependency "com.unity.shadergraph@file:../Graphics/com.unity.shadergraph" --project-path .
    - unity-config project add dependency com.unity.addressables@1.16.7 --project-path .
    - unity-config project add dependency com.unity.scriptablebuildpipeline@1.11.2 --project-path .
    - unity-config project add dependency com.unity.test-framework@1.1.29 --project-path .
    - unity-config project add dependency com.unity.test-framework.performance@2.4.0 --project-path .
    - unity-config project add dependency com.unity.test-framework.utp-reporter@1.0.2-preview --project-path .
    - unity-config project add dependency com.unity.test-framework.build@0.0.1-preview.12 --project-path .
    - unity-config project add dependency "com.unity.testing.graphics-performance@ssh://git@github.cds.internal.unity3d.com/unity/com.unity.testing.graphics-performance.git"  --project-path .
    - unity-config project add dependency "unity.graphictests.performance.universal@ssh://git@github.cds.internal.unity3d.com/unity/unity.graphictests.performance.universal.git" --project-path .
    - unity-config project add testable com.unity.cli-project-setup  --project-path .
    - unity-config project add testable com.unity.test.performance.runtimesettings  --project-path .
    - unity-config project add testable com.unity.test.metadata-manager  --project-path .
    - unity-config project add testable com.unity.testing.graphics-performance --project-path .
    - unity-config project add testable com.unity.render-pipelines.core  --project-path .
    - unity-config project add testable unity.graphictests.performance.universal  --project-path .
    - unity-config project set project-update false --project-path .
    - pip install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
    # note: --fast tells unity downloader to get the latest available version editor. 
    # Saves some time in case if editor is building after batch landed to trunk
    # You might want to remove it in our production environment.
    - unity-downloader-cli -c Editor -c iOS -u $UNITY_BRANCH --wait 
    - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr --output utr
    - chmod +x ./utr
    - ./utr --suite=playmode --platform=iOS --editor-location=.Editor --testproject=. --player-save-path=build/players --artifacts_path=build/logs --architecture=ARM64 --build-only
  artifacts:
    players:
        paths:
          - "build/players/**"
    logs:
        paths:
          - "build/logs/**"

Run_Player_With_Tests_iOS:
  name: Run Test on an iOS player
  variables:
    UNITY_BRANCH: trunk
  # no need to clone repo
  skip_checkout: true
  agent:
      # Running tests is fast, building it not requried, therefore flavor can be smaller. see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
      # Now we can use an 'expensive' type. 
      type: Unity::mobile::iPhone
      image: mobile/macos-10.15-testing:stable
      flavor: b1.medium
  dependencies:
    - .yamato/ios.yml#Build_Player_With_Tests_iOS
  commands:
    - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr  --output utr
    - chmod +x ./utr
    - ./utr --suite=playmode --platform=iOS --player-load-path=build/players --artifacts_path=build/test-results
  artifacts:
    logs:
        paths:
          - "build/test-results/**"
