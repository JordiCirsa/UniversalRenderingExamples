  Build_Player_With_Tests_StandaloneLinux64:
    name: Build Players with tests StandaloneLinux64
    variables:
      UNITY_BRANCH: trunk
    agent:
        # Do not choose machines with GPUs or connected devices to perform this step
        # If it takes a lot of time to compile your project prefer flavor with more cores.
        # see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
        type: Unity::VM
        image: cds-ops/ubuntu-18.04-base:stable
        flavor: b1.xlarge
    commands:
      - git clone git@github.com:Unity-Technologies/Graphics.git
      - sudo rm -f /etc/apt/sources.list /etc/apt/sources.list.d/{nodesource,teamviewer,deadsnakes-ubuntu-ppa-}*
      - curl -L https://artifactory.prd.it.unity3d.com/artifactory/api/gpg/key/public | sudo apt-key add -
      - sudo sh -c "echo 'deb https://artifactory.prd.it.unity3d.com/artifactory/unity-apt-local bionic main' > /etc/apt/sources.list.d/unity.list"
      - sudo apt update
      - sudo apt install -y unity-config
      - unity-config project add dependency "com.unity.render-pipelines.core@file:../Graphics/com.unity.render-pipelines.core" --project-path .
      - unity-config project add dependency "com.unity.render-pipelines.universal@file:../Graphics/com.unity.render-pipelines.universal" --project-path .
      - unity-config project add dependency "com.unity.shadergraph@file:../Graphics/com.unity.shadergraph" --project-path .
      - unity-config project add dependency com.unity.addressables@1.16.7 --project-path .
      - unity-config project add dependency com.unity.scriptablebuildpipeline@1.11.2 --project-path .
      - unity-config project add dependency com.unity.test-framework@1.1.29 --project-path .
      - unity-config project add dependency com.unity.test-framework.performance@2.4.0 --project-path .
      - unity-config project add dependency com.unity.test-framework.utp-reporter@1.0.2-preview --project-path .
      - unity-config project add dependency com.unity.test-framework.build@0.0.1-preview.12 --project-path .
      - unity-config project add dependency "com.unity.testing.graphics-performance@ssh://git@github.cds.internal.unity3d.com/unity/com.unity.testing.graphics-performance.git"  --project-path .
      - unity-config project add dependency "unity.graphictests.performance.universal@ssh://git@github.cds.internal.unity3d.com/unity/unity.graphictests.performance.universal.git" --project-path .
      - unity-config project add testable com.unity.cli-project-setup  --project-path .
      - unity-config project add testable com.unity.test.performance.runtimesettings  --project-path .
      - unity-config project add testable com.unity.test.metadata-manager  --project-path .
      - unity-config project add testable com.unity.testing.graphics-performance --project-path .
      - unity-config project add testable com.unity.render-pipelines.core  --project-path .
      - unity-config project add testable unity.graphictests.performance.universal  --project-path .
      - unity-config project set project-update false --project-path .
      - sudo pip install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
      - unity-downloader-cli -u $UNITY_BRANCH -c editor --wait --published --wait
      - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr  --output utr
      - chmod +x ./utr
      - ./utr --suite=playmode --platform=StandaloneLinux64 --editor-location=.Editor --testproject=. --player-save-path=build/players --artifacts_path=build/logs --build-only
    artifacts:
      players:
          paths:
            - "build/players/**"
      logs:
          paths:
            - "build/logs/**"
            
  Run_Player_With_Tests_StandaloneLinux64:
    name: Run Test on a linux64 standalone player
    # no need to clone a repo
    skip_checkout: true
    agent:
        # Running tests is fast, building it not requried, therefore flavor can be smaller. see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
        # Now we can use an 'expensive' type. 
        type: Unity::VM::GPU
        image: cds-ops/ubuntu-18.04-base:stable
        flavor: b1.large
    dependencies:
      - path: .yamato/standalone_linux.yml#Build_Player_With_Tests_StandaloneLinux64
        rerun: always
    variables:
      UNITY_BRANCH: trunk
      DISPLAY: :0.0
    commands:
      - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr  --output utr
      - chmod +x ./utr
      - ./utr --suite=playmode --platform=StandaloneLinux64 --player-load-path=build/players --artifacts_path=build/test-results --player-connection-ip=auto
    artifacts:
      logs:
          paths:
            - "build/test-results/**"
